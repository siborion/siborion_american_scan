diff -r 341aa9279f2b base.db
Binary file base.db has changed
diff -r 341aa9279f2b device.cpp
--- a/device.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/device.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -1,7 +1,11 @@
 #include "device.h"
 #include <qdebug.h>
 #include <QDateTime>
+#include <QTime>
 #include <QApplication>
+#include <QMessageBox>
+
+#define comLen 1
 
 Device::Device(QObject *parent) :
     QObject(parent)
@@ -9,7 +13,7 @@
     doDll = true;
     port = new QSerialPort(this);
     timer = new QTimer();
-    timer->setInterval(50);
+    timer->setInterval(68);
     connect(timer,SIGNAL(timeout()),SLOT(doTimer()));
 }
 
@@ -42,7 +46,7 @@
     port->setDataBits(QSerialPort::Data8);
     port->setParity(QSerialPort::NoParity);
     port->setStopBits(QSerialPort::OneStop);
-    port->setFlowControl(QSerialPort::NoFlowControl);
+    port->setFlowControl(QSerialPort::HardwareControl);
     port->waitForBytesWritten(-1);
     if(*doMeasure)
     {
@@ -61,6 +65,13 @@
             if((ftStatus != FT_OK)||(ftNumDevice==0))
                 return;
             FT_Out_Buffer[0] = 'A';
+            FT_Out_Buffer[1] = 'T';
+            FT_Out_Buffer[2] = '+';
+            FT_Out_Buffer[3] = 'G';
+            FT_Out_Buffer[4] = 'M';
+            FT_Out_Buffer[5] = 'I';
+            FT_Out_Buffer[6] = 0x0d;
+            FT_Out_Buffer[7] = 0x0a;
             ftStatus = FT_Open(0, &ftHandle);
             if(ftStatus!=FT_OK)
                 return;
@@ -76,6 +87,8 @@
         {
             if(port->open(QIODevice::ReadWrite))
             {
+                port->setRequestToSend(true);
+                port->setDataTerminalReady(true);
                 *doMeasure = true;
                 timer->start();
             }
@@ -85,34 +98,40 @@
 
 void Device::doTimer()
 {
-    QByteArray baTmp;
-    quint16 kolvo = 0;
-    DWORD BytesWritten;
-    DWORD BytesReceived;
-    DWORD BytesReceivedCount;
-    char RxBuffer[2048];
+    baTmp.clear();
     if(doDll)
     {
         FT_GetQueueStatus(ftHandle, &BytesReceivedCount);
-        if(BytesReceivedCount>=1023)
+
+//        QMessageBox msg;
+//        msg.setText(QString("%1").arg(BytesReceivedCount));
+//        msg.exec();
+
+        if(BytesReceivedCount==1024)
+//        if(BytesReceivedCount>=27)
         {
+//            qDebug()<<QTime::currentTime().msec();
+//            BytesReceivedCount &= 0x3ff;
             FT_Read(ftHandle,RxBuffer,BytesReceivedCount,&BytesReceived);
             FT_Purge(ftHandle,1);
-            for(int i=0; i<=1023; i++)
-            {
-                baTmp.append((unsigned char)(RxBuffer[i]));
-                kolvo++;
-            }
-            emit resiveData(baTmp.left(1024));
+            ftStatus = FT_Write(ftHandle, FT_Out_Buffer, comLen, &BytesWritten);
+            baTmp.append(RxBuffer,1023);
+            emit resiveData(&baTmp);
         }
-        ftStatus = FT_Write(ftHandle, FT_Out_Buffer, 1,  &BytesWritten);
+        else
+        {
+//            qDebug()<<"-"<<QTime::currentTime().msec();
+            FT_Purge(ftHandle,1);
+            ftStatus = FT_Write(ftHandle, FT_Out_Buffer, comLen, &BytesWritten);
+        }
     }
     else
     {
-        baTmp = port->readAll();
-        port->write("A", 1);
-        if(baTmp.count()>=1024)
-            emit resiveData(baTmp.left(1024));
+        baTmp=port->read(1024);
+        port->readAll();
+        port->write("AT+GMI\r\n", comLen);
+        if(baTmp.length()>=1024)
+            emit resiveData(&baTmp);
     }
 }
 
diff -r 341aa9279f2b device.h
--- a/device.h	Fri Jan 16 20:22:35 2015 +0600
+++ b/device.h	Wed Jan 28 17:52:07 2015 +0600
@@ -27,8 +27,16 @@
     FT_HANDLE ftHandle;
     char FT_Out_Buffer[10];
 
+    DWORD BytesWritten;
+    DWORD BytesReceived;
+    DWORD BytesReceivedCount;
+    char RxBuffer[2048];
+
+
+    QByteArray baTmp;
+
 signals:
-    void resiveData(QByteArray);
+    void resiveData(QByteArray*);
 
 private slots:
     void openDevice(bool *doMeasure);
diff -r 341aa9279f2b main.cpp
--- a/main.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/main.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -3,7 +3,12 @@
 
 int main(int argc, char *argv[])
 {
+    QStringList paths = QCoreApplication::libraryPaths();
+    paths.append(".");
+    paths.append("platforms");
+    QCoreApplication::setLibraryPaths(paths);
     QApplication a(argc, argv);
+    a.addLibraryPath(a.applicationDirPath()+"/plugins");
     MainWindow w;
     w.show();
     return a.exec();
diff -r 341aa9279f2b mainwindow.cpp
--- a/mainwindow.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/mainwindow.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -52,7 +52,7 @@
 
     connect(measure,SIGNAL(doScan(bool*)),device,SLOT(openDevice(bool*)));
     connect(measure,SIGNAL(refreshTable(stMeasureParam*)),parcer,SLOT(calculateParam(stMeasureParam*)));
-    connect(device,SIGNAL(resiveData(QByteArray)),SLOT(resiveDataSlot(QByteArray)));
+    connect(device,SIGNAL(resiveData(QByteArray*)),SLOT(resiveDataSlot(QByteArray*)));
 
     connect(measure,SIGNAL(stopMeasure()),device,SLOT(stopMeasure()));
 
@@ -71,14 +71,14 @@
     move(0,0);
 }
 
-void MainWindow::resiveDataSlot(QByteArray Sample)
+void MainWindow::resiveDataSlot(QByteArray *Sample)
 {
     stMeasureParam measureParam;
     QList<quint16> exstremum;
-    measure->resiveData(&Sample);
-    if(parcer->findExtremum(&Sample, &exstremum, &measureParam))
+    measure->resiveData(Sample);
+    if(parcer->findExtremum(Sample, &exstremum, &measureParam))
     {
-        measure->addSample(&Sample, &exstremum, &measureParam);
+        measure->addSample(Sample, &exstremum, &measureParam);
     }
 }
 
diff -r 341aa9279f2b mainwindow.h
--- a/mainwindow.h	Fri Jan 16 20:22:35 2015 +0600
+++ b/mainwindow.h	Wed Jan 28 17:52:07 2015 +0600
@@ -36,7 +36,7 @@
     void moveWindowToCenter();
 
 public slots:
-    void resiveDataSlot(QByteArray);
+    void resiveDataSlot(QByteArray*);
     void setStPatient(QMap <QString, QString> *stPatientBases);
 
 Q_SIGNALS:
diff -r 341aa9279f2b plot.cpp
--- a/plot.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/plot.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -40,7 +40,7 @@
     dMin=(-20.0); dMax=(1024.0);
     setAxisScale(QwtPlot::xTop, dMin, dMax);
     setAxisScale(QwtPlot::xBottom, (dMin/27), (dMax/27));
-    setAxisScale(QwtPlot::yLeft, -4, 280.0);
+    setAxisScale(QwtPlot::yLeft, -4, 600.0);
 
     QPalette palette;
     palette.setColor(QPalette::WindowText, Qt::gray);
diff -r 341aa9279f2b plugins/sqldrivers/qsqlite.dll
Binary file plugins/sqldrivers/qsqlite.dll has changed
diff -r 341aa9279f2b release/scan.exe
Binary file release/scan.exe has changed
diff -r 341aa9279f2b sampletable.cpp
--- a/sampletable.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/sampletable.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -88,6 +88,7 @@
                 {
                 measureParam.ACD = query.value(query.record().indexOf("acd")).toDouble();
                 measureParam.AL  = query.value(query.record().indexOf("al")).toDouble();
+                measureParam.LT  = query.value(query.record().indexOf("lt")).toDouble();
                 measureParam.ALave  = query.value(query.record().indexOf("al_ave")).toDouble();
                 measureParam.Cornea = query.value(query.record().indexOf("cornea")).toUInt();
                 measureParam.L1 = query.value(query.record().indexOf("l1")).toUInt();
diff -r 341aa9279f2b scan.pro
--- a/scan.pro	Fri Jan 16 20:22:35 2015 +0600
+++ b/scan.pro	Wed Jan 28 17:52:07 2015 +0600
@@ -107,6 +107,7 @@
     scan.qrc
 
 OTHER_FILES += \
-    qwt.prf
+    qwt.prf \
+    plugins/sqldrivers/qsqlite.dll
 
-OTHER_FILES += plugins/sqldrivers/qsqlite.dll
+#OTHER_FILES += plugins/sqldrivers/qsqlite.dll
diff -r 341aa9279f2b scanbase.cpp
--- a/scanbase.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/scanbase.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -9,7 +9,13 @@
     sCurPath = QDir::currentPath();
     sCurPath.append("/base.db");
     pDB = QSqlDatabase::addDatabase("QSQLITE");
+//    qDebug()<<pDB;
     pDB.setDatabaseName(sCurPath);
+    
+
+    QMessageBox msgBox;
+//    msgBox.setText(sCurPath);
+//    msgBox.exec();
 
     modelBases = new QSqlQueryModel();
 
@@ -44,8 +50,8 @@
     }
     else
     {
-//        msgBox.setText("File not found");
-//        msgBox.exec();
+        msgBox.setText("File not found");
+        msgBox.exec();
     }
 
 
diff -r 341aa9279f2b scanbase.h
--- a/scanbase.h	Fri Jan 16 20:22:35 2015 +0600
+++ b/scanbase.h	Wed Jan 28 17:52:07 2015 +0600
@@ -28,7 +28,7 @@
     QSqlQueryModel *modelBases;
     QMap <QString, QString> curPatient;
     QMap <QString, QString> curDoctor;
-    QMap <QString, QString> curLens;\
+    QMap <QString, QString> curLens;
     QSqlQueryModel lensModel;
 
 public slots:
diff -r 341aa9279f2b scanbutton.cpp
--- a/scanbutton.cpp	Fri Jan 16 20:22:35 2015 +0600
+++ b/scanbutton.cpp	Wed Jan 28 17:52:07 2015 +0600
@@ -6,7 +6,7 @@
     QIcon icon;
     doMeasure = false;
     timer = new QTimer();
-    timer->start(200);
+    timer->start(300);
     icon.addFile(QStringLiteral(":/test/scan"), QSize(), QIcon::Normal, QIcon::Off);
     setIcon(icon);
     setIconSize(QSize(30, 30));
